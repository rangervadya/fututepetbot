<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Твой Будущий Питомец | Партнёр</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Chart.js для графиков -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== ОСНОВНЫЕ СТИЛИ ===== */
        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --secondary: #81C784;
            --accent: #388E3C;
            --light: #E8F5E9;
            --dark: #1B5E20;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --info: #2196F3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
            color: #2E7D32;
            min-height: 100vh;
            padding: 15px;
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(46, 125, 50, 0.15);
            overflow: hidden;
            border: 1px solid #E8F5E9;
        }
        
        /* ===== ШАПКА ===== */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .logo-text h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }
        
        .logo-text .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ===== НАВИГАЦИЯ ===== */
        .nav-tabs {
            display: flex;
            background: var(--light);
            padding: 8px;
            border-bottom: 1px solid #C8E6C9;
            gap: 8px;
        }
        
        .nav-tab {
            flex: 1;
            padding: 14px 10px;
            border: none;
            background: transparent;
            color: var(--secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .nav-tab i {
            font-size: 20px;
        }
        
        /* ===== КОНТЕНТ ===== */
        .content {
            padding: 20px;
            min-height: 500px;
        }
        
        .page {
            display: none;
            animation: slideIn 0.4s;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ===== КАРТОЧКИ ===== */
        .card {
            background: white;
            border-radius: 20px;
            padding: 22px;
            margin-bottom: 18px;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.08);
            border: 1px solid #E8F5E9;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-badge {
            background: var(--primary-light);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ===== СТАТИСТИКА ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: var(--light);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid #C8E6C9;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--secondary);
            font-weight: 600;
        }
        
        /* ===== КНОПКИ ===== */
        .btn {
            padding: 18px 24px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary-light);
        }
        
        /* ===== ЗАЯВКИ ===== */
        .lead-item {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #E8F5E9;
            border-left: 4px solid var(--primary-light);
        }
        
        .lead-item.new {
            border-left-color: var(--warning);
            background: #FFF8E1;
        }
        
        .lead-item.contacted {
            border-left-color: var(--info);
            background: #E3F2FD;
        }
        
        .lead-item.booked {
            border-left-color: #9C27B0;
            background: #F3E5F5;
        }
        
        .lead-item.done {
            border-left-color: var(--success);
            background: var(--light);
        }
        
        .lead-item.rejected {
            border-left-color: var(--danger);
            background: #FFEBEE;
        }
        
        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .lead-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
        }
        
        .lead-time {
            font-size: 12px;
            color: var(--secondary);
            background: rgba(129, 199, 132, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .lead-content {
            margin-bottom: 15px;
        }
        
        .lead-field {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .lead-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-new { background: #FFF3E0; color: #EF6C00; }
        .status-contacted { background: #E3F2FD; color: #1565C0; }
        .status-booked { background: #F3E5F5; color: #7B1FA2; }
        .status-done { background: #E8F5E9; color: var(--primary); }
        .status-rejected { background: #FFEBEE; color: #C62828; }
        
        /* ===== ФОРМЫ ===== */
        .form-group {
            margin-bottom: 22px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #C8E6C9;
            border-radius: 12px;
            font-size: 16px;
            background: #F9FDF8;
            color: var(--primary);
            font-family: inherit;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* ===== УВЕДОМЛЕНИЯ ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 18px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideInRight 0.4s;
            max-width: 350px;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ===== УТИЛИТЫ ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--secondary); font-size: 14px; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Шапка -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-paw"></i>
                </div>
                <div class="logo-text">
                    <h1>Твой Будущий Питомец</h1>
                    <div class="subtitle">Партнёрский кабинет</div>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-store"></i>
                </div>
                <div>
                    <div id="partnerName">Загрузка...</div>
                    <div id="partnerType" style="font-size:12px;opacity:0.9;">Ветклиника</div>
                </div>
            </div>
        </header>
        
        <!-- Навигация -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-page="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Дашборд</span>
            </button>
            <button class="nav-tab" data-page="leads">
                <i class="fas fa-inbox"></i>
                <span>Заявки</span>
                <span class="badge-new" id="leadsBadge" style="display:none;"></span>
            </button>
            <button class="nav-tab" data-page="offers">
                <i class="fas fa-tags"></i>
                <span>Акции</span>
            </button>
            <button class="nav-tab" data-page="analytics">
                <i class="fas fa-chart-pie"></i>
                <span>Аналитика</span>
            </button>
            <button class="nav-tab" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </button>
        </nav>
        
        <!-- Контент -->
        <main class="content">
            <!-- Дашборд -->
            <div id="dashboard" class="page active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-tachometer-alt"></i> Общая статистика
                        </div>
                        <span class="card-badge" id="dashboardDate">Сегодня</span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="statTotalLeads">0</div>
                            <div class="stat-label">Всего заявок</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statNewLeads">0</div>
                            <div class="stat-label">Новых</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statConversion">0%</div>
                            <div class="stat-label">Конверсия</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statRating">0.0</div>
                            <div class="stat-label">Рейтинг</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-bolt"></i> Быстрые действия
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mb-20" onclick="showPage('create-offer')">
                        <i class="fas fa-plus-circle"></i> Создать акцию
                    </button>
                    
                    <button class="btn btn-secondary mb-20" onclick="loadLeads()">
                        <i class="fas fa-eye"></i> Просмотр заявок
                    </button>
                    
                    <button class="btn btn-outline" onclick="generateReferralLink()">
                        <i class="fas fa-share-alt"></i> Виджет приглашения
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clock"></i> Последние заявки
                        </div>
                        <span class="card-badge">24ч</span>
                    </div>
                    
                    <div id="recentLeadsList" class="list">
                        <!-- Заявки будут загружены -->
                    </div>
                </div>
            </div>
            
            <!-- Заявки -->
            <div id="leads" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-inbox"></i> Управление заявками
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary btn-small" onclick="refreshLeads()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportLeadsCSV()">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Фильтры -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <select class="form-select" id="filterStatus" onchange="filterLeads()">
                            <option value="all">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="contacted">В работе</option>
                            <option value="booked">Забронировано</option>
                            <option value="done">Завершено</option>
                            <option value="rejected">Отклонено</option>
                        </select>
                        
                        <select class="form-select" id="filterDate" onchange="filterLeads()">
                            <option value="all">Все время</option>
                            <option value="today">Сегодня</option>
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                        </select>
                    </div>
                    
                    <!-- Список заявок -->
                    <div id="leadsListContainer">
                        <!-- Заявки загружаются динамически -->
                    </div>
                </div>
            </div>
            
            <!-- Детальная информация о заявке -->
            <div id="lead-detail" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-file-alt"></i> Детали заявки
                        </div>
                        <button class="btn btn-outline btn-small" onclick="showPage('leads')">
                            <i class="fas fa-arrow-left"></i> Назад
                        </button>
                    </div>
                    
                    <div id="leadDetailContent">
                        <!-- Загружается динамически -->
                    </div>
                </div>
            </div>
            
            <!-- Акции -->
            <div id="offers" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-tags"></i> Акции и услуги
                        </div>
                        <button class="btn btn-primary btn-small" onclick="showPage('create-offer')">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                    
                    <div id="offersList" class="list">
                        <!-- Акции загружаются динамически -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-bar"></i> Статистика акций
                        </div>
                    </div>
                    
                    <canvas id="offersChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- Создание акции -->
            <div id="create-offer" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-plus-circle"></i> Создать акцию
                        </div>
                        <button class="btn btn-outline btn-small" onclick="showPage('offers')">
                            <i class="fas fa-arrow-left"></i> Назад
                        </button>
                    </div>
                    
                    <form id="offerForm">
                        <div class="form-group">
                            <label class="form-label">Заголовок акции *</label>
                            <input type="text" class="form-input" id="offerTitle" required
                                   placeholder="Например: Скидка 20% на первый приём">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Описание *</label>
                            <textarea class="form-textarea" id="offerDescription" required
                                      placeholder="Подробное описание акции..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Категория</label>
                            <select class="form-select" id="offerCategory">
                                <option value="vaccine">Вакцинация</option>
                                <option value="sterilization">Стерилизация</option>
                                <option value="grooming">Груминг</option>
                                <option value="consultation">Консультация</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Срок действия</label>
                            <input type="date" class="form-input" id="offerExpiry">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Промокод (необязательно)</label>
                            <input type="text" class="form-input" id="offerPromoCode"
                                   placeholder="Например: PETLOVE2024">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить акцию
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Аналитика -->
            <div id="analytics" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-pie"></i> Аналитика заявок
                        </div>
                        <select class="form-select" id="analyticsPeriod" style="width: auto;">
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="quarter">Квартал</option>
                            <option value="year">Год</option>
                        </select>
                    </div>
                    
                    <canvas id="leadsChart" width="400" height="300"></canvas>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-users"></i> Конверсия по источникам
                        </div>
                    </div>
                    
                    <div id="sourcesList" class="list">
                        <!-- Источники загружаются динамически -->
                    </div>
                </div>
            </div>
            
            <!-- Настройки -->
            <div id="settings" class="page">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-cog"></i> Настройки профиля
                        </div>
                    </div>
                    
                    <form id="settingsForm">
                        <div class="form-group">
                            <label class="form-label">Название организации</label>
                            <input type="text" class="form-input" id="settingOrgName">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Тип организации</label>
                            <select class="form-select" id="settingOrgType">
                                <option value="clinic">Ветклиника</option>
                                <option value="shelter">Приют</option>
                                <option value="shop">Зоомагазин</option>
                                <option value="grooming">Груминг</option>
                                <option value="hotel">Гостиница</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Адрес</label>
                            <input type="text" class="form-input" id="settingAddress">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Район Казани</label>
                            <select class="form-select" id="settingDistrict">
                                <option value="">Выберите район</option>
                                <option>Авиастроительный</option>
                                <option>Вахитовский</option>
                                <option>Кировский</option>
                                <option>Московский</option>
                                <option>Ново-Савиновский</option>
                                <option>Приволжский</option>
                                <option>Советский</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Телефон для связи</label>
                            <input type="tel" class="form-input" id="settingPhone">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Описание</label>
                            <textarea class="form-textarea" id="settingDescription"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Часы работы</label>
                            <input type="text" class="form-input" id="settingHours"
                                   placeholder="09:00-21:00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telegram для получения лидов</label>
                            <input type="text" class="form-input" id="settingTgContact"
                                   placeholder="@username или номер телефона">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить настройки
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-shield-alt"></i> Безопасность
                        </div>
                    </div>
                    
                    <button class="btn btn-outline mb-20" onclick="clearLocalData()">
                        <i class="fas fa-trash"></i> Очистить локальные данные
                    </button>
                    
                    <button class="btn btn-outline" onclick="exportAllData()">
                        <i class="fas fa-database"></i> Экспорт всех данных
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification hidden">
        <i class="fas fa-check-circle"></i>
        <div id="notificationText"></div>
        <button class="notification-close" onclick="hideNotification()">&times;</button>
    </div>

    <script>
        // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
        let tg = window.Telegram.WebApp;
        let currentPartner = null;
        let partnerData = {};
        let partnerLeads = [];
        let partnerOffers = [];
        let analyticsData = {};
        
        // ===== ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ =====
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Инициализация Telegram Web App
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();
            
            // 2. Загрузка данных партнёра
            loadPartnerData();
            
            // 3. Инициализация навигации
            initNavigation();
            
            // 4. Инициализация форм
            initForms();
            
            // 5. Загрузка данных
            setTimeout(() => {
                loadAllData();
                showNotification('Приложение загружено!', 'success');
            }, 500);
        });
        
        // ===== СИСТЕМА ХРАНЕНИЯ ДАННЫХ =====
        
        // Получение уникального ID партнёра
        function getPartnerId() {
            if (tg.initDataUnsafe?.user?.id) {
                return `partner_${tg.initDataUnsafe.user.id}`;
            }
            return 'partner_guest';
        }
        
        // Сохранение данных в localStorage (по партнёру)
        function savePartnerData(key, data) {
            const partnerId = getPartnerId();
            const storageKey = `${partnerId}_${key}`;
            localStorage.setItem(storageKey, JSON.stringify(data));
        }
        
        // Загрузка данных из localStorage (по партнёру)
        function loadPartnerDataFromStorage(key, defaultValue = null) {
            const partnerId = getPartnerId();
            const storageKey = `${partnerId}_${key}`;
            const data = localStorage.getItem(storageKey);
            return data ? JSON.parse(data) : defaultValue;
        }
        
        // Очистка данных партнёра
        function clearPartnerData() {
            const prefix = getPartnerId();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    localStorage.removeItem(key);
                }
            }
        }
        
        // ===== ЗАГРУЗКА ДАННЫХ ПАРТНЁРА =====
        function loadPartnerData() {
            // Загружаем профиль партнёра
            partnerData = loadPartnerDataFromStorage('profile', {
                id: getPartnerId(),
                name: 'Моя организация',
                type: 'clinic',
                address: '',
                district: '',
                phone: '',
                description: '',
                hours: '09:00-21:00',
                tgContact: '',
                createdAt: new Date().toISOString()
            });
            
            // Обновляем UI
            document.getElementById('partnerName').textContent = partnerData.name;
            document.getElementById('partnerType').textContent = 
                getPartnerTypeLabel(partnerData.type);
            
            // Загружаем заявки
            partnerLeads = loadPartnerDataFromStorage('leads', []);
            
            // Загружаем акции
            partnerOffers = loadPartnerDataFromStorage('offers', []);
            
            // Загружаем аналитику
            analyticsData = loadPartnerDataFromStorage('analytics', {
                totalLeads: 0,
                convertedLeads: 0,
                sources: {}
            });
            
            console.log('Данные партнёра загружены:', partnerData);
        }
        
        // Сохранение данных партнёра
        function saveAllPartnerData() {
            savePartnerData('profile', partnerData);
            savePartnerData('leads', partnerLeads);
            savePartnerData('offers', partnerOffers);
            savePartnerData('analytics', analyticsData);
        }
        
        // ===== НАВИГАЦИЯ =====
        function initNavigation() {
            // Обработчики для вкладок
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const pageId = this.dataset.page;
                    showPage(pageId);
                });
            });
        }
        
        function showPage(pageId) {
            // Скрываем все страницы
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Сбрасываем активные вкладки
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем нужную страницу
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
                
                // Загружаем данные для страницы
                switch(pageId) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'leads':
                        loadLeads();
                        break;
                    case 'offers':
                        loadOffers();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                    case 'settings':
                        loadSettings();
                        break;
                }
            }
            
            // Активируем вкладку
            const tab = document.querySelector(`[data-page="${pageId}"]`);
            if (tab) {
                tab.classList.add('active');
            }
            
            window.scrollTo(0, 0);
        }
        
        // ===== ДАШБОРД =====
        function loadDashboard() {
            // Обновляем статистику
            const totalLeads = partnerLeads.length;
            const newLeads = partnerLeads.filter(lead => lead.status === 'new').length;
            const convertedLeads = partnerLeads.filter(lead => lead.status === 'done').length;
            const conversionRate = totalLeads > 0 ? Math.round((convertedLeads / totalLeads) * 100) : 0;
            
            document.getElementById('statTotalLeads').textContent = totalLeads;
            document.getElementById('statNewLeads').textContent = newLeads;
            document.getElementById('statConversion').textContent = conversionRate + '%';
            document.getElementById('statRating').textContent = '4.8';
            
            // Обновляем список последних заявок
            updateRecentLeads();
            
            // Обновляем дату
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dashboardDate').textContent = 
                now.toLocaleDateString('ru-RU', options);
        }
        
        function updateRecentLeads() {
            const container = document.getElementById('recentLeadsList');
            container.innerHTML = '';
            
            // Сортируем по дате (последние первые)
            const recentLeads = [...partnerLeads]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 3);
            
            if (recentLeads.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">Нет заявок</div>';
                return;
            }
            
            recentLeads.forEach(lead => {
                const leadDiv = document.createElement('div');
                leadDiv.className = 'list-item';
                leadDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${lead.name}</div>
                        <div style="font-size: 12px; color: var(--secondary);">
                            ${getLeadTypeLabel(lead.type)} • ${formatDate(lead.createdAt)}
                        </div>
                    </div>
                    <span class="status-badge status-${lead.status}">
                        ${getStatusLabel(lead.status)}
                    </span>
                `;
                leadDiv.onclick = () => showLeadDetail(lead.id);
                container.appendChild(leadDiv);
            });
        }
        
        // ===== ЗАЯВКИ =====
        function loadLeads() {
            const container = document.getElementById('leadsListContainer');
            container.innerHTML = '';
            
            if (partnerLeads.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="padding: 40px 20px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: var(--secondary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">Нет заявок</h3>
                        <p class="text-muted">Заявки от пользователей появятся здесь</p>
                    </div>
                `;
                return;
            }
            
            // Фильтрация
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFilter = document.getElementById('filterDate').value;
            
            let filteredLeads = partnerLeads;
            
            if (statusFilter !== 'all') {
                filteredLeads = filteredLeads.filter(lead => lead.status === statusFilter);
            }
            
            if (dateFilter !== 'all') {
                const now = new Date();
                let cutoffDate = new Date();
                
                switch(dateFilter) {
                    case 'today':
                        cutoffDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        cutoffDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        cutoffDate.setMonth(now.getMonth() - 1);
                        break;
                }
                
                filteredLeads = filteredLeads.filter(lead => 
                    new Date(lead.createdAt) >= cutoffDate
                );
            }
            
            // Сортировка по дате (новые первые)
            filteredLeads.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Отображение
            filteredLeads.forEach(lead => {
                const leadCard = document.createElement('div');
                leadCard.className = `lead-item ${lead.status}`;
                leadCard.innerHTML = `
                    <div class="lead-header">
                        <div class="lead-title">${lead.name}</div>
                        <div class="lead-time">${formatDate(lead.createdAt)}</div>
                    </div>
                    <div class="lead-content">
                        <div class="lead-field">
                            <i class="fas fa-phone"></i>
                            <span>${lead.phone}</span>
                        </div>
                        <div class="lead-field">
                            <i class="fas fa-bullseye"></i>
                            <span>${getLeadTypeLabel(lead.type)}</span>
                        </div>
                        ${lead.comment ? `
                        <div class="lead-field">
                            <i class="fas fa-comment"></i>
                            <span style="color: var(--secondary);">${lead.comment.substring(0, 100)}...</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="lead-actions">
                        <button class="btn btn-outline btn-small" onclick="changeLeadStatus('${lead.id}', 'contacted')">
                            <i class="fas fa-phone"></i> Взять в работу
                        </button>
                        <button class="btn btn-primary btn-small" onclick="showLeadDetail('${lead.id}')">
                            <i class="fas fa-eye"></i> Подробнее
                        </button>
                    </div>
                `;
                container.appendChild(leadCard);
            });
            
            // Обновляем бейдж
            updateLeadsBadge();
        }
        
        function filterLeads() {
            loadLeads();
        }
        
        function refreshLeads() {
            showNotification('Заявки обновлены', 'success');
            loadLeads();
        }
        
        function showLeadDetail(leadId) {
            const lead = partnerLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            const container = document.getElementById('leadDetailContent');
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div class="lead-field">
                        <i class="fas fa-user"></i>
                        <strong>Клиент:</strong> ${lead.name}
                    </div>
                    <div class="lead-field">
                        <i class="fas fa-phone"></i>
                        <strong>Телефон:</strong> ${lead.phone}
                    </div>
                    <div class="lead-field">
                        <i class="fas fa-bullseye"></i>
                        <strong>Цель:</strong> ${getLeadTypeLabel(lead.type)}
                    </div>
                    <div class="lead-field">
                        <i class="fas fa-calendar"></i>
                        <strong>Дата:</strong> ${formatDate(lead.createdAt, true)}
                    </div>
                    ${lead.pet ? `
                    <div class="lead-field">
                        <i class="fas fa-paw"></i>
                        <strong>Питомец:</strong> ${lead.pet}
                    </div>
                    ` : ''}
                </div>
                
                ${lead.comment ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--dark); margin-bottom: 10px;">
                        <i class="fas fa-comment"></i> Комментарий
                    </h4>
                    <div style="background: var(--light); padding: 15px; border-radius: 12px;">
                        ${lead.comment}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--dark); margin-bottom: 10px;">
                        <i class="fas fa-history"></i> История статусов
                    </h4>
                    <div id="leadHistory">
                        <!-- История будет загружена -->
                    </div>
                </div>
                
                <div class="lead-actions">
                    <select class="form-select" id="leadStatusSelect" style="flex: 1;">
                        <option value="new" ${lead.status === 'new' ? 'selected' : ''}>Новая</option>
                        <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>В работе</option>
                        <option value="booked" ${lead.status === 'booked' ? 'selected' : ''}>Забронировано</option>
                        <option value="done" ${lead.status === 'done' ? 'selected' : ''}>Завершено</option>
                        <option value="rejected" ${lead.status === 'rejected' ? 'selected' : ''}>Отклонено</option>
                    </select>
                    <button class="btn btn-primary" onclick="updateLeadStatus('${lead.id}')">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
                
                <div class="lead-actions" style="margin-top: 20px;">
                    <button class="btn btn-outline" onclick="callClient('${lead.phone}')">
                        <i class="fas fa-phone"></i> Позвонить
                    </button>
                    <button class="btn btn-outline" onclick="sendMessage('${lead.id}')">
                        <i class="fas fa-comment"></i> Написать
                    </button>
                </div>
            `;
            
            // Загружаем историю
            loadLeadHistory(leadId);
            
            showPage('lead-detail');
        }
        
        function loadLeadHistory(leadId) {
            const history = loadPartnerDataFromStorage(`lead_${leadId}_history`, [
                {
                    status: 'new',
                    timestamp: new Date().toISOString(),
                    note: 'Заявка создана'
                }
            ]);
            
            const container = document.getElementById('leadHistory');
            container.innerHTML = '';
            
            history.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'list-item';
                itemDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${getStatusLabel(item.status)}</div>
                        <div style="font-size: 12px; color: var(--secondary);">
                            ${formatDate(item.timestamp, true)}
                        </div>
                        ${item.note ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${item.note}</div>` : ''}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function updateLeadStatus(leadId) {
            const newStatus = document.getElementById('leadStatusSelect').value;
            const leadIndex = partnerLeads.findIndex(l => l.id === leadId);
            
            if (leadIndex === -1) return;
            
            // Обновляем статус
            partnerLeads[leadIndex].status = newStatus;
            partnerLeads[leadIndex].updatedAt = new Date().toISOString();
            
            // Добавляем в историю
            const history = loadPartnerDataFromStorage(`lead_${leadId}_history`, []);
            history.push({
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: 'Статус изменён вручную'
            });
            savePartnerData(`lead_${leadId}_history`, history);
            
            // Сохраняем все данные
            saveAllPartnerData();
            
            showNotification('Статус обновлён', 'success');
            showPage('leads');
        }
        
        function changeLeadStatus(leadId, status) {
            const leadIndex = partnerLeads.findIndex(l => l.id === leadId);
            if (leadIndex === -1) return;
            
            partnerLeads[leadIndex].status = status;
            partnerLeads[leadIndex].updatedAt = new Date().toISOString();
            
            saveAllPartnerData();
            showNotification('Статус изменён', 'success');
            loadLeads();
        }
        
        // Симуляция получения новой заявки
        function simulateNewLead() {
            const newLead = {
                id: 'lead_' + Date.now(),
                name: 'Иван Иванов',
                phone: '+7 (900) 123-45-67',
                type: 'adoption',
                comment: 'Хочу забрать котёнка из приюта',
                pet: 'Котёнок, 3 месяца',
                status: 'new',
                source: 'telegram',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            partnerLeads.unshift(newLead);
            saveAllPartnerData();
            
            showNotification('Новая заявка!', 'success');
            updateLeadsBadge();
            if (document.getElementById('leads').classList.contains('active')) {
                loadLeads();
            }
        }
        
        // ===== АКЦИИ =====
        function loadOffers() {
            const container = document.getElementById('offersList');
            container.innerHTML = '';
            
            if (partnerOffers.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="padding: 40px 20px;">
                        <i class="fas fa-tags" style="font-size: 48px; color: var(--secondary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">Нет акций</h3>
                        <p class="text-muted">Создайте первую акцию для привлечения клиентов</p>
                    </div>
                `;
                return;
            }
            
            partnerOffers.forEach(offer => {
                const offerDiv = document.createElement('div');
                offerDiv.className = 'list-item';
                offerDiv.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--dark);">${offer.title}</div>
                        <div style="font-size: 12px; color: var(--secondary); margin-top: 5px;">
                            ${offer.description.substring(0, 100)}...
                        </div>
                        <div style="font-size: 12px; color: var(--accent); margin-top: 5px;">
                            <i class="fas fa-calendar"></i> До ${formatDate(offer.expiry)}
                        </div>
                    </div>
                    <div>
                        <span class="card-badge">${offer.category}</span>
                    </div>
                `;
                offerDiv.onclick = () => editOffer(offer.id);
                container.appendChild(offerDiv);
            });
        }
        
        function initForms() {
            // Форма создания акции
            document.getElementById('offerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newOffer = {
                    id: 'offer_' + Date.now(),
                    title: document.getElementById('offerTitle').value,
                    description: document.getElementById('offerDescription').value,
                    category: document.getElementById('offerCategory').value,
                    expiry: document.getElementById('offerExpiry').value,
                    promoCode: document.getElementById('offerPromoCode').value,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };
                
                partnerOffers.push(newOffer);
                saveAllPartnerData();
                
                showNotification('Акция создана!', 'success');
                showPage('offers');
                this.reset();
            });
            
            // Форма настроек
            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                partnerData.name = document.getElementById('settingOrgName').value;
                partnerData.type = document.getElementById('settingOrgType').value;
                partnerData.address = document.getElementById('settingAddress').value;
                partnerData.district = document.getElementById('settingDistrict').value;
                partnerData.phone = document.getElementById('settingPhone').value;
                partnerData.description = document.getElementById('settingDescription').value;
                partnerData.hours = document.getElementById('settingHours').value;
                partnerData.tgContact = document.getElementById('settingTgContact').value;
                
                saveAllPartnerData();
                
                showNotification('Настройки сохранены!', 'success');
            });
        }
        
        function loadSettings() {
            document.getElementById('settingOrgName').value = partnerData.name;
            document.getElementById('settingOrgType').value = partnerData.type;
            document.getElementById('settingAddress').value = partnerData.address;
            document.getElementById('settingDistrict').value = partnerData.district;
            document.getElementById('settingPhone').value = partnerData.phone;
            document.getElementById('settingDescription').value = partnerData.description;
            document.getElementById('settingHours').value = partnerData.hours;
            document.getElementById('settingTgContact').value = partnerData.tgContact;
        }
        
        // ===== АНАЛИТИКА =====
        function loadAnalytics() {
            // Создаём график заявок
            const ctx = document.getElementById('leadsChart').getContext('2d');
            
            // Группируем заявки по дням
            const last7Days = [...Array(7)].map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();
            
            const leadsByDay = last7Days.map(day => {
                return partnerLeads.filter(lead => 
                    lead.createdAt.split('T')[0] === day
                ).length;
            });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => formatDate(date)),
                    datasets: [{
                        label: 'Заявки',
                        data: leadsByDay,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
            
            // Загружаем источники
            loadSources();
        }
        
        function loadSources() {
            const sources = {};
            
            partnerLeads.forEach(lead => {
                const source = lead.source || 'unknown';
                sources[source] = (sources[source] || 0) + 1;
            });
            
            const container = document.getElementById('sourcesList');
            container.innerHTML = '';
            
            Object.entries(sources).forEach(([source, count]) => {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'list-item';
                sourceDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${getSourceLabel(source)}</div>
                        <div style="font-size: 12px; color: var(--secondary);">
                            ${count} заявок
                        </div>
                    </div>
                    <div>
                        <span class="card-badge">
                            ${Math.round((count / partnerLeads.length) * 100)}%
                        </span>
                    </div>
                `;
                container.appendChild(sourceDiv);
            });
        }
        
        // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====
        
        function getPartnerTypeLabel(type) {
            const labels = {
                clinic: 'Ветклиника',
                shelter: 'Приют',
                shop: 'Зоомагазин',
                grooming: 'Груминг',
                hotel: 'Гостиница'
            };
            return labels[type] || type;
        }
        
        function getLeadTypeLabel(type) {
            const labels = {
                adoption: 'Усыновление',
                appointment: 'Запись на приём',
                question: 'Вопрос',
                other: 'Другое'
            };
            return labels[type] || type;
        }
        
        function getStatusLabel(status) {
            const labels = {
                new: 'Новая',
                contacted: 'В работе',
                booked: 'Забронировано',
                done: 'Завершено',
                rejected: 'Отклонено'
            };
            return labels[status] || status;
        }
        
        function getSourceLabel(source) {
            const labels = {
                telegram: 'Telegram',
                website: 'Сайт',
                referral: 'Реферальная',
                unknown: 'Неизвестно'
            };
            return labels[source] || source;
        }
        
        function formatDate(dateString, withTime = false) {
            const date = new Date(dateString);
            if (withTime) {
                return date.toLocaleDateString('ru-RU') + ' ' + 
                       date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('ru-RU');
        }
        
        function updateLeadsBadge() {
            const newLeadsCount = partnerLeads.filter(lead => lead.status === 'new').length;
            const badge = document.getElementById('leadsBadge');
            
            if (newLeadsCount > 0) {
                badge.textContent = newLeadsCount;
                badge.style.display = 'inline-block';
                badge.style.background = 'var(--warning)';
                badge.style.color = 'white';
                badge.style.borderRadius = '50%';
                badge.style.width = '20px';
                badge.style.height = '20px';
                badge.style.display = 'flex';
                badge.style.alignItems = 'center';
                badge.style.justifyContent = 'center';
                badge.style.fontSize = '10px';
                badge.style.marginTop = '-10px';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function showNotification(text, type = 'info') {
            const notification = document.getElementById('notification');
            const textElement = document.getElementById('notificationText');
            
            // Устанавливаем иконку по типу
            const icon = notification.querySelector('i');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
                notification.style.background = 'var(--primary)';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
                notification.style.background = 'var(--danger)';
            } else {
                icon.className = 'fas fa-info-circle';
                notification.style.background = 'var(--info)';
            }
            
            textElement.textContent = text;
            notification.classList.remove('hidden');
            
            // Автоматическое скрытие
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }
        
        function hideNotification() {
            document.getElementById('notification').classList.add('hidden');
        }
        
        function callClient(phone) {
            showNotification(`Звоним на ${phone}...`, 'success');
            // В реальном приложении: window.open(`tel:${phone}`);
        }
        
        function sendMessage(leadId) {
            showNotification('Сообщение отправлено', 'success');
        }
        
        function generateReferralLink() {
            const referralCode = `partner_${partnerData.id}_${Date.now().toString(36)}`;
            const link = `https://t.me/your_bot?start=${referralCode}`;
            
            alert(`Ваша реферальная ссылка:\n\n${link}\n\nПоделитесь ею для привлечения клиентов!`);
        }
        
        function exportLeadsCSV() {
            let csv = 'Имя,Телефон,Цель,Статус,Дата,Комментарий\n';
            
            partnerLeads.forEach(lead => {
                csv += `"${lead.name}","${lead.phone}","${getLeadTypeLabel(lead.type)}","${getStatusLabel(lead.status)}","${formatDate(lead.createdAt)}","${lead.comment || ''}"\n`;
            });
            
            // Создаём и скачиваем файл
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `leads_${formatDate(new Date().toISOString())}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Данные экспортированы в CSV', 'success');
        }
        
        function clearLocalData() {
            if (confirm('Вы уверены? Это удалит все локальные данные.')) {
                clearPartnerData();
                location.reload();
            }
        }
        
        function exportAllData() {
            const data = {
                partner: partnerData,
                leads: partnerLeads,
                offers: partnerOffers,
                analytics: analyticsData,
                exportedAt: new Date().toISOString()
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `partner_data_${partnerData.id}_${Date.now()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Все данные экспортированы', 'success');
        }
        
        function loadAllData() {
            loadDashboard();
            loadOffers();
            updateLeadsBadge();
            
            // Симуляция новых данных для демонстрации
            setTimeout(() => {
                if (partnerLeads.length === 0) {
                    simulateNewLead();
                    simulateNewLead();
                }
            }, 1000);
        }
        
        // Тестирование: добавление тестовой заявки
        window.addTestLead = function() {
            simulateNewLead();
        };
        
        // Инициализация при загрузке
        console.log('🚀 Партнёрский кабинет загружен!');
    </script>
</body>
</html>
